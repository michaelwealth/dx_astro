---
// Cookie Consent Banner - Non-obstructive, fully WCAG compliant
// Respects user preferences and manages cookie consent with local storage
---

<div id="cookie-consent-banner" class="cookie-banner" role="region" aria-label="Cookie consent notice" aria-live="polite">
  <div class="cookie-content">
    <div class="cookie-info">
      <h2 class="cookie-title">Cookie Preferences</h2>
      <p class="cookie-description">
        We use cookies to enhance your browsing experience, analyze site traffic, and personalize content. 
        We respect your privacy and only use essential cookies by default.
      </p>
    </div>
    
    <div class="cookie-controls">
      <div class="cookie-checkbox-group">
        <label class="cookie-checkbox-label">
          <input 
            type="checkbox" 
            id="essential-cookies" 
            name="essential" 
            checked 
            disabled
            class="cookie-checkbox"
            aria-label="Essential cookies - required for basic functionality"
          />
          <span class="cookie-label-text">
            Essential Cookies
            <span class="cookie-required">(Always enabled)</span>
          </span>
        </label>
        
        <label class="cookie-checkbox-label">
          <input 
            type="checkbox" 
            id="analytics-cookies" 
            name="analytics"
            class="cookie-checkbox"
            aria-label="Analytics cookies - help us understand how you use our site"
          />
          <span class="cookie-label-text">Analytics Cookies</span>
        </label>
        
        <label class="cookie-checkbox-label">
          <input 
            type="checkbox" 
            id="marketing-cookies" 
            name="marketing"
            class="cookie-checkbox"
            aria-label="Marketing cookies - used for targeted advertising"
          />
          <span class="cookie-label-text">Marketing Cookies</span>
        </label>
      </div>
      
      <div class="cookie-actions">
        <button 
          id="accept-all-btn" 
          class="btn btn-cookie btn-accept-all"
          aria-label="Accept all cookies"
        >
          Accept All
        </button>
        <button 
          id="accept-selected-btn" 
          class="btn btn-cookie btn-accept-selected"
          aria-label="Accept selected cookies"
        >
          Accept Selected
        </button>
        <button 
          id="reject-btn" 
          class="btn btn-cookie btn-reject"
          aria-label="Reject non-essential cookies"
        >
          Reject
        </button>
        <a 
          href="/privacy" 
          class="cookie-link"
          aria-label="Learn more about our privacy policy"
        >
          Privacy Policy
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  interface CookiePreferences {
    essential: boolean;
    analytics: boolean;
    marketing: boolean;
    timestamp: number;
  }

  const COOKIE_CONSENT_KEY = 'dx-cookie-consent';
  const COOKIE_EXPIRY_DAYS = 365;

  function getCookiePreferences(): CookiePreferences | null {
    try {
      const stored = localStorage.getItem(COOKIE_CONSENT_KEY);
      return stored ? JSON.parse(stored) : null;
    } catch {
      return null;
    }
  }

  function saveCookiePreferences(prefs: CookiePreferences): void {
    localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(prefs));
    // Set tracking cookies in browser if user consented
    setTrackingCookies(prefs);
  }

  function setTrackingCookies(prefs: CookiePreferences): void {
    // Google Analytics (only if user consented)
    if (prefs.analytics) {
      // Initialize GA if available
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('consent', 'update', {
          'analytics_storage': 'granted'
        });
      }
    }
    
    // Marketing/Ads cookies
    if (prefs.marketing) {
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('consent', 'update', {
          'ad_storage': 'granted'
        });
      }
    }
  }

  function hideCookieBanner(): void {
    const banner = document.getElementById('cookie-consent-banner');
    if (banner) {
      banner.classList.add('hidden');
    }
  }

  function showCookieBanner(): void {
    const banner = document.getElementById('cookie-consent-banner');
    if (banner) {
      banner.classList.remove('hidden');
    }
  }

  function initializeCookieConsent(): void {
    const existingPrefs = getCookiePreferences();
    
    // If user has already made a choice, hide the banner
    if (existingPrefs) {
      hideCookieBanner();
      return;
    }

    // Show banner if no preferences set
    showCookieBanner();

    // Setup button handlers
    const acceptAllBtn = document.getElementById('accept-all-btn');
    const acceptSelectedBtn = document.getElementById('accept-selected-btn');
    const rejectBtn = document.getElementById('reject-btn');

    if (acceptAllBtn) {
      acceptAllBtn.addEventListener('click', () => {
        const prefs: CookiePreferences = {
          essential: true,
          analytics: true,
          marketing: true,
          timestamp: Date.now()
        };
        saveCookiePreferences(prefs);
        hideCookieBanner();
      });
    }

    if (acceptSelectedBtn) {
      acceptSelectedBtn.addEventListener('click', () => {
        const analyticsCheckbox = document.getElementById('analytics-cookies') as HTMLInputElement;
        const marketingCheckbox = document.getElementById('marketing-cookies') as HTMLInputElement;

        const prefs: CookiePreferences = {
          essential: true,
          analytics: analyticsCheckbox?.checked ?? false,
          marketing: marketingCheckbox?.checked ?? false,
          timestamp: Date.now()
        };
        saveCookiePreferences(prefs);
        hideCookieBanner();
      });
    }

    if (rejectBtn) {
      rejectBtn.addEventListener('click', () => {
        const prefs: CookiePreferences = {
          essential: true,
          analytics: false,
          marketing: false,
          timestamp: Date.now()
        };
        saveCookiePreferences(prefs);
        hideCookieBanner();
      });
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCookieConsent);
  } else {
    initializeCookieConsent();
  }
</script>

<style>
  .cookie-banner {
    position: fixed;
    bottom: 24px;
    right: 24px;
    max-width: 420px;
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    padding: var(--space-xl);
    z-index: 10000;
    animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--color-text);
  }

  .cookie-banner.hidden {
    display: none;
  }

  /* Dark mode support */
  :global([data-theme="dark"]) .cookie-banner {
    background: var(--color-neutral-800, #1f2937);
    border-color: var(--color-neutral-700, #374151);
    color: var(--color-white);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .cookie-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .cookie-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .cookie-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
    color: var(--color-text);
  }

  :global([data-theme="dark"]) .cookie-title {
    color: var(--color-white);
  }

  .cookie-description {
    margin: 0;
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-text-light);
  }

  :global([data-theme="dark"]) .cookie-description {
    color: var(--color-neutral-400, #d1d5db);
  }

  .cookie-controls {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .cookie-checkbox-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .cookie-checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    cursor: pointer;
    user-select: none;
  }

  .cookie-checkbox {
    width: 18px;
    height: 18px;
    margin-top: 2px;
    cursor: pointer;
    accent-color: var(--color-primary);
  }

  .cookie-checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .cookie-label-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-weight: 500;
  }

  .cookie-required {
    font-size: 0.75rem;
    font-weight: 400;
    color: var(--color-text-light);
  }

  :global([data-theme="dark"]) .cookie-required {
    color: var(--color-neutral-400, #d1d5db);
  }

  .cookie-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .btn-cookie {
    padding: var(--space-sm) var(--space-lg);
    border: none;
    border-radius: var(--radius-lg);
    font-size: 0.8125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    white-space: nowrap;
  }

  .btn-accept-all {
    background: var(--color-primary);
    color: white;
  }

  .btn-accept-all:hover {
    background: #ff4444;
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(255, 87, 87, 0.3);
  }

  .btn-accept-all:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .btn-accept-selected {
    background: var(--color-border);
    color: var(--color-text);
  }

  :global([data-theme="dark"]) .btn-accept-selected {
    background: var(--color-neutral-700, #374151);
    color: var(--color-white);
  }

  .btn-accept-selected:hover {
    background: #e5e7eb;
  }

  :global([data-theme="dark"]) .btn-accept-selected:hover {
    background: var(--color-neutral-600, #4b5563);
  }

  .btn-accept-selected:focus-visible {
    outline: 2px solid var(--color-text);
    outline-offset: 2px;
  }

  .btn-reject {
    background: transparent;
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  :global([data-theme="dark"]) .btn-reject {
    color: var(--color-white);
    border-color: var(--color-neutral-700, #374151);
  }

  .btn-reject:hover {
    background: var(--color-cream);
    border-color: var(--color-text);
  }

  :global([data-theme="dark"]) .btn-reject:hover {
    background: var(--color-neutral-800, #1f2937);
    border-color: var(--color-neutral-400, #d1d5db);
  }

  .btn-reject:focus-visible {
    outline: 2px solid var(--color-text);
    outline-offset: 2px;
  }

  .cookie-link {
    font-size: 0.8125rem;
    color: var(--color-primary);
    text-decoration: none;
    text-align: center;
    transition: color 0.3s ease;
  }

  :global([data-theme="dark"]) .cookie-link {
    color: #ff7f7f;
  }

  .cookie-link:hover {
    text-decoration: underline;
  }

  .cookie-link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .cookie-banner {
      bottom: 16px;
      right: 16px;
      left: 16px;
      max-width: none;
      padding: var(--space-lg);
    }

    .cookie-actions {
      flex-direction: column;
    }

    .btn-cookie {
      width: 100%;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .cookie-banner {
      animation: none;
    }

    .btn-cookie {
      transition: none;
    }

    .btn-accept-all:hover {
      transform: none;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: more) {
    .cookie-banner {
      border-width: 2px;
    }

    .cookie-checkbox {
      border: 2px solid currentColor;
    }

    .btn-cookie {
      border: 2px solid currentColor;
    }
  }

  /* Print styles */
  @media print {
    .cookie-banner {
      display: none;
    }
  }
</style>
